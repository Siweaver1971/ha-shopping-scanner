#!/usr/bin/with-contenv bashio
bashio::log.info "Starting Shopping Scanner..."

cd /var/www/html

# Check if SUPERVISOR_TOKEN exists
if [ -z "${SUPERVISOR_TOKEN}" ]; then
    bashio::log.error "SUPERVISOR_TOKEN is not set!"
else
    bashio::log.info "SUPERVISOR_TOKEN is available (length: ${#SUPERVISOR_TOKEN})"
fi

# Create config.js with ingress-compatible settings
cat > config.js << EOF
window.HA_CONFIG = {
    haUrl: '/api',
    haToken: '${SUPERVISOR_TOKEN}'
};
EOF

bashio::log.info "Configuration written to config.js"

if [ -f "config.js" ]; then
    bashio::log.info "config.js created successfully"
else
    bashio::log.error "Failed to create config.js"
fi

bashio::log.info "Starting web server on port 8099..."
exec python3 -m http.server 8099