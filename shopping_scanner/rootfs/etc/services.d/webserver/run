#!/usr/bin/with-contenv bashio
bashio::log.info "Starting Shopping Scanner..."

cd /var/www/html

bashio::log.info "Configuring for Ingress authentication"

# Create config.js that constructs the correct API URL
cat > config.js << EOF
(function() {
    // Extract the base URL (everything before /hassio/ingress/)
    const currentUrl = window.location.href;
    const baseUrl = currentUrl.split('/hassio/ingress/')[0];
    
    window.HA_CONFIG = {
        haUrl: baseUrl,  // Will be https://bdna7sfnwdzzpne2opcrkugq9fowrqdw.ui.nabu.casa
        haToken: ''      // Empty - ingress handles auth via session
    };
    
    console.log('Shopping Scanner Configuration:');
    console.log('Current URL:', currentUrl);
    console.log('Base URL:', baseUrl);
    console.log('API URL:', baseUrl + '/api');
    
    // Test connection
    fetch(baseUrl + '/api/config')
        .then(r => {
            console.log('Connection test status:', r.status);
            if (r.ok) {
                console.log('âœ“ Connected to Home Assistant');
                return r.json();
            }
            throw new Error('HTTP ' + r.status);
        })
        .then(data => console.log('HA Location:', data.location_name))
        .catch(err => console.error('Connection test failed:', err));
})();
EOF

bashio::log.info "Configuration written with dynamic URL detection"

if [ ! -f "config.js" ]; then
    bashio::log.error "Failed to create config.js"
    exit 1
fi

bashio::log.info "Starting web server on port 8099..."
exec python3 -m http.server 8099