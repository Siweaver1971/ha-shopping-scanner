<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#9C27B0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Shopping Scanner">
    <title>Shopping Scanner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #9C27B0;
            --primary-dark: #7B1FA2;
            --primary-light: #BA68C8;
            --accent: #E1BEE7;
            --background: #121212;
            --surface: #1E1E1E;
            --surface-light: #2C2C2C;
            --text-primary: #FFFFFF;
            --text-secondary: #B0B0B0;
            --success: #4CAF50;
            --error: #F44336;
            --warning: #FF9800;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            overflow-x: hidden;
            padding-bottom: 70px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(156, 39, 176, 0.3);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-icon {
            width: 32px;
            height: 32px;
        }

        /* Content */
        .content {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Scanner View */
        #scanner-view {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .scan-button {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none;
            padding: 20px;
            border-radius: 16px;
            color: white;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(156, 39, 176, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .scan-button:active {
            transform: scale(0.98);
        }

        #scanner-container {
            position: relative;
            width: 100%;
            height: 400px;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            display: none;
        }

        #scanner-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 200px;
            border: 3px solid var(--primary);
            border-radius: 12px;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
        }

        .scanner-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: var(--primary);
            animation: scan 2s ease-in-out infinite;
        }

        @keyframes scan {
            0%, 100% { top: 0; }
            50% { top: 100%; }
        }

        /* Cards */
        .card {
            background: var(--surface);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
        }

        .card-subtitle {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 4px;
        }

        /* Product Item */
        .product-item {
            display: flex;
            gap: 16px;
            align-items: center;
            padding: 16px;
            background: var(--surface);
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .product-item:active {
            transform: scale(0.98);
            background: var(--surface-light);
        }

        .product-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            background: var(--surface-light);
            flex-shrink: 0;
        }

        .product-info {
            flex: 1;
            min-width: 0;
        }

        .product-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .product-barcode {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .delete-btn {
            background: var(--error);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-btn:active {
            transform: scale(0.9);
        }

        /* Shopping List Item */
        .list-item {
            display: flex;
            gap: 12px;
            align-items: center;
            padding: 16px;
            background: var(--surface);
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .list-item.completed {
            opacity: 0.5;
        }

        .list-item.completed .list-item-text {
            text-decoration: line-through;
        }

        .checkbox {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--primary);
            flex-shrink: 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checkbox.checked {
            background: var(--primary);
            position: relative;
        }

        .checkbox.checked::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
        }

        .list-item-text {
            flex: 1;
        }

        /* Input */
        input, textarea {
            width: 100%;
            padding: 12px;
            background: var(--surface-light);
            border: 2px solid transparent;
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-secondary {
            background: var(--surface-light);
            color: var(--text-primary);
        }

        .btn:active {
            transform: scale(0.98);
        }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            padding: 12px;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.3);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            font-size: 12px;
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .nav-icon {
            width: 24px;
            height: 24px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--surface);
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            z-index: 1001;
            display: none;
            max-width: 90%;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--error);
        }

        .toast.warning {
            background: var(--warning);
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 3px solid var(--surface-light);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .connection-status {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .connection-status.connected {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success);
        }

        .connection-status.disconnected {
            background: rgba(244, 67, 54, 0.2);
            color: var(--error);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>
            <svg class="header-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 2L7 6H3L6 11V18H10V11L13 6H9L11 2H9Z"/>
                <rect x="6" y="18" width="12" height="4"/>
                <path d="M12 6v12"/>
                <path d="M6 10h12"/>
            </svg>
            Shopping Scanner
        </h1>
    </div>

    <div class="content">
        <!-- Connection Status -->
        <div id="connection-status" class="connection-status connected">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            <span>Connected to Home Assistant</span>
        </div>

        <!-- Scanner View -->
        <div id="scanner-view">
            <button class="scan-button" onclick="startScanning()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                    <path d="M9 3v18M15 3v18M3 9h18M3 15h18"/>
                </svg>
                Start Scanning
            </button>

            <div id="scanner-container">
                <div class="scanner-overlay">
                    <div class="scanner-line"></div>
                </div>
            </div>

            <div id="recent-scans" class="card">
                <div class="card-header">
                    <div class="card-title">Recent Scans</div>
                </div>
                <div id="recent-list"></div>
            </div>
        </div>

        <!-- Products View -->
        <div id="products-view" class="hidden">
            <div class="card">
                <input type="text" id="search-products" placeholder="Search products..." oninput="searchProducts()">
            </div>
            <div id="products-list"></div>
        </div>

        <!-- Shopping List View -->
        <div id="list-view" class="hidden">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Your Shopping List</div>
                    <button class="btn btn-secondary" onclick="refreshShoppingList()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 12a9 9 0 11-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/>
                            <path d="M21 3v5h-5"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="shopping-list"></div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchView('scanner')">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"/>
                <path d="M9 3v18M15 3v18"/>
            </svg>
            Scan
        </div>
        <div class="nav-item" onclick="switchView('products')">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 7h-2a2 2 0 01-2-2V3m-4 0v2a2 2 0 01-2 2H8m12 6v6a2 2 0 01-2 2H6a2 2 0 01-2-2V9a2 2 0 012-2h12a2 2 0 012 2z"/>
            </svg>
            Products
        </div>
        <div class="nav-item" onclick="switchView('list')">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
            List
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="add-product-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add Product</div>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="form-group">
                <label>Product Name</label>
                <input type="text" id="new-product-name" placeholder="Enter product name">
            </div>
            <div class="form-group">
                <label>Barcode</label>
                <input type="text" id="new-product-barcode" readonly>
            </div>
            <button class="btn btn-primary" onclick="saveNewProduct()">Add to List</button>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <script>
        // Configuration - automatically injected by Home Assistant
        const CONFIG = {
            haUrl: '{{HA_URL}}',
            haToken: '{{SUPERVISOR_TOKEN}}'
        };

        // Initialize
        let db;
        let scanning = false;
        let currentBarcode = '';
        let allProducts = [];

        // Initialize IndexedDB for product storage
        function initDB() {
            const request = indexedDB.open('ShoppingScanner', 1);
            
            request.onerror = () => console.error('DB error');
            
            request.onsuccess = (e) => {
                db = e.target.result;
                loadRecentScans();
                loadProducts();
                checkConnection();
            };
            
            request.onupgradeneeded = (e) => {
                db = e.target.result;
                if (!db.objectStoreNames.contains('products')) {
                    db.createObjectStore('products', { keyPath: 'barcode' });
                }
                if (!db.objectStoreNames.contains('scans')) {
                    const scansStore = db.createObjectStore('scans', { keyPath: 'id', autoIncrement: true });
                    scansStore.createIndex('timestamp', 'timestamp', { unique: false });
                }
            };
        }

        // Check Home Assistant connection
        async function checkConnection() {
            try {
                const response = await fetch(`${CONFIG.haUrl}/api/`, {
                    headers: {
                        'Authorization': `Bearer ${CONFIG.haToken}`
                    }
                });
                
                const statusEl = document.getElementById('connection-status');
                if (response.ok) {
                    statusEl.className = 'connection-status connected';
                    statusEl.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                        <span>Connected to Home Assistant</span>
                    `;
                } else {
                    throw new Error('Connection failed');
                }
            } catch (err) {
                console.error('Connection error:', err);
                const statusEl = document.getElementById('connection-status');
                statusEl.className = 'connection-status disconnected';
                statusEl.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="15" y1="9" x2="9" y2="15"/>
                        <line x1="9" y1="9" x2="15" y2="15"/>
                    </svg>
                    <span>Connection Error</span>
                `;
            }
        }

        // Start scanning
        function startScanning() {
            if (scanning) {
                stopScanning();
                return;
            }

            document.getElementById('scanner-container').style.display = 'block';
            document.querySelector('.scan-button').textContent = 'Stop Scanning';
            scanning = true;

            Quagga.init({
                inputStream: {
                    type: 'LiveStream',
                    target: document.querySelector('#scanner-container'),
                    constraints: {
                        width: { min: 640, ideal: 1280 },
                        height: { min: 480, ideal: 720 },
                        facingMode: 'environment'
                    }
                },
                decoder: {
                    readers: ['ean_reader', 'ean_8_reader', 'upc_reader', 'upc_e_reader']
                }
            }, (err) => {
                if (err) {
                    console.error(err);
                    showToast('Camera access denied', 'error');
                    stopScanning();
                    return;
                }
                Quagga.start();
            });

            Quagga.onDetected((result) => {
                if (scanning && result.codeResult && result.codeResult.code) {
                    handleBarcode(result.codeResult.code);
                    stopScanning();
                }
            });
        }

        function stopScanning() {
            if (scanning) {
                Quagga.stop();
                scanning = false;
                document.getElementById('scanner-container').style.display = 'none';
                document.querySelector('.scan-button').innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <path d="M9 3v18M15 3v18M3 9h18M3 15h18"/>
                    </svg>
                    Start Scanning
                `;
            }
        }

        // Handle scanned barcode
        async function handleBarcode(barcode) {
            currentBarcode = barcode;
            showToast('Looking up product...', 'success');

            // Check local database first
            const localProduct = await getProduct(barcode);
            if (localProduct) {
                await addToShoppingList(localProduct.name);
                await recordScan(localProduct);
                loadRecentScans();
                return;
            }

            // Lookup from Open Food Facts
            try {
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                const data = await response.json();
                
                if (data.status === 1 && data.product && data.product.product_name) {
                    const product = {
                        barcode: barcode,
                        name: data.product.product_name,
                        brand: data.product.brands || '',
                        image: data.product.image_url || '',
                        timestamp: Date.now()
                    };
                    
                    await saveProduct(product);
                    await addToShoppingList(product.name);
                    await recordScan(product);
                    loadRecentScans();
                } else {
                    showAddProductModal(barcode);
                }
            } catch (err) {
                console.error(err);
                showAddProductModal(barcode);
            }
        }

        // Add product to HA shopping list
        async function addToShoppingList(productName) {
            try {
                const response = await fetch(`${CONFIG.haUrl}/api/services/todo/add_item`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${CONFIG.haToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        entity_id: 'todo.shopping_list',
                        item: productName
                    })
                });

                if (response.ok) {
                    showToast(`Added: ${productName}`, 'success');
                } else {
                    throw new Error('Failed to add to list');
                }
            } catch (err) {
                console.error(err);
                showToast('Error adding to Home Assistant', 'error');
            }
        }

        // Get shopping list from HA
        async function refreshShoppingList() {
            const listDiv = document.getElementById('shopping-list');
            listDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading...</p></div>';

            try {
                const response = await fetch(`${CONFIG.haUrl}/api/states/todo.shopping_list`, {
                    headers: {
                        'Authorization': `Bearer ${CONFIG.haToken}`
                    }
                });

                if (!response.ok) throw new Error('Failed to fetch list');

                const data = await response.json();
                
                // Get the actual items
                const itemsResponse = await fetch(`${CONFIG.haUrl}/api/todo/todo.shopping_list`, {
                    headers: {
                        'Authorization': `Bearer ${CONFIG.haToken}`
                    }
                });

                if (!itemsResponse.ok) throw new Error('Failed to fetch items');

                const items = await itemsResponse.json();
                
                displayShoppingList(items);
            } catch (err) {
                console.error(err);
                listDiv.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="15" y1="9" x2="9" y2="15"/>
                            <line x1="9" y1="9" x2="15" y2="15"/>
                        </svg>
                        <p>Could not load shopping list</p>
                        <p style="font-size: 12px; margin-top: 8px;">Check your connection</p>
                    </div>
                `;
            }
        }

        function displayShoppingList(items) {
            const listDiv = document.getElementById('shopping-list');
            
            if (!items || items.length === 0) {
                listDiv.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                            <path d="M10 14l2 2 4-4"/>
                        </svg>
                        <p>Your shopping list is empty!</p>
                    </div>
                `;
                return;
            }

            listDiv.innerHTML = items.map(item => `
                <div class="list-item ${item.status === 'completed' ? 'completed' : ''}">
                    <div class="checkbox ${item.status === 'completed' ? 'checked' : ''}" 
                         onclick="toggleItem('${item.uid}', '${item.status}')"></div>
                    <div class="list-item-text">${item.summary}</div>
                </div>
            `).join('');
        }

        async function toggleItem(uid, currentStatus) {
            const newStatus = currentStatus === 'completed' ? 'needs_action' : 'completed';
            
            try {
                const response = await fetch(`${CONFIG.haUrl}/api/services/todo/update_item`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${CONFIG.haToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        entity_id: 'todo.shopping_list',
                        item: uid,
                        status: newStatus
                    })
                });

                if (response.ok) {refreshShoppingList();
                }
            } catch (err) {
                console.error(err);
                showToast('Error updating item', 'error');
            }
        }

        // Database operations
        function getProduct(barcode) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['products'], 'readonly');
                const store = transaction.objectStore('products');
                const request = store.get(barcode);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function saveProduct(product) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['products'], 'readwrite');
                const store = transaction.objectStore('products');
                const request = store.put(product);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function recordScan(product) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['scans'], 'readwrite');
                const store = transaction.objectStore('scans');
                const request = store.add({
                    ...product,
                    timestamp: Date.now()
                });
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // Load recent scans
        function loadRecentScans() {
            const transaction = db.transaction(['scans'], 'readonly');
            const store = transaction.objectStore('scans');
            const index = store.index('timestamp');
            const request = index.openCursor(null, 'prev');
            const scans = [];

            request.onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor && scans.length < 5) {
                    scans.push(cursor.value);
                    cursor.continue();
                } else {
                    displayRecentScans(scans);
                }
            };
        }

        function displayRecentScans(scans) {
            const listDiv = document.getElementById('recent-list');
            
            if (scans.length === 0) {
                listDiv.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <path d="M9 3v18M15 3v18"/>
                        </svg>
                        <p>No recent scans</p>
                    </div>
                `;
                return;
            }

            listDiv.innerHTML = scans.map(scan => `
                <div class="product-item" onclick="addToShoppingList('${scan.name}')">
                    <img src="${scan.image || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'60\' height=\'60\'%3E%3Crect fill=\'%232C2C2C\' width=\'60\' height=\'60\'/%3E%3C/svg%3E'}" class="product-image" alt="${scan.name}">
                    <div class="product-info">
                        <div class="product-name">${scan.name}</div>
                        <div class="product-barcode">${scan.barcode}</div>
                    </div>
                </div>
            `).join('');
        }

        // Load all products
        function loadProducts() {
            const transaction = db.transaction(['products'], 'readonly');
            const store = transaction.objectStore('products');
            const request = store.getAll();

            request.onsuccess = () => {
                allProducts = request.result;
                displayProducts(allProducts);
            };
        }

        function displayProducts(products) {
            const listDiv = document.getElementById('products-list');
            
            if (products.length === 0) {
                listDiv.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 7h-2a2 2 0 01-2-2V3m-4 0v2a2 2 0 01-2 2H8m12 6v6a2 2 0 01-2 2H6a2 2 0 01-2-2V9a2 2 0 012-2h12a2 2 0 012 2z"/>
                        </svg>
                        <p>No products yet</p>
                        <p style="font-size: 12px; margin-top: 8px;">Scan a barcode to add products</p>
                    </div>
                `;
                return;
            }

            listDiv.innerHTML = products.map(product => `
                <div class="product-item">
                    <img src="${product.image || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'60\' height=\'60\'%3E%3Crect fill=\'%232C2C2C\' width=\'60\' height=\'60\'/%3E%3C/svg%3E'}" class="product-image" alt="${product.name}">
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-barcode">${product.barcode}</div>
                    </div>
                    <button class="delete-btn" onclick="deleteProduct('${product.barcode}')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        function searchProducts() {
            const query = document.getElementById('search-products').value.toLowerCase();
            const filtered = allProducts.filter(p => 
                p.name.toLowerCase().includes(query) || 
                p.barcode.includes(query)
            );
            displayProducts(filtered);
        }

        function deleteProduct(barcode) {
            if (!confirm('Delete this product?')) return;
            
            const transaction = db.transaction(['products'], 'readwrite');
            const store = transaction.objectStore('products');
            store.delete(barcode);
            
            transaction.oncomplete = () => {
                loadProducts();
                showToast('Product deleted', 'success');
            };
        }

        // Modal functions
        function showAddProductModal(barcode) {
            document.getElementById('new-product-barcode').value = barcode;
            document.getElementById('new-product-name').value = '';
            document.getElementById('add-product-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('add-product-modal').classList.remove('active');
        }

        async function saveNewProduct() {
            const name = document.getElementById('new-product-name').value.trim();
            const barcode = document.getElementById('new-product-barcode').value;
            
            if (!name) {
                showToast('Please enter a product name', 'error');
                return;
            }
            
            const product = {
                barcode: barcode,
                name: name,
                brand: '',
                image: '',
                timestamp: Date.now()
            };
            
            await saveProduct(product);
            await addToShoppingList(name);
            await recordScan(product);
            loadRecentScans();
            loadProducts();
            closeModal();
        }

        // View switching
        function switchView(view) {
            // Hide all views
            document.getElementById('scanner-view').classList.add('hidden');
            document.getElementById('products-view').classList.add('hidden');
            document.getElementById('list-view').classList.add('hidden');
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected view
            if (view === 'scanner') {
                document.getElementById('scanner-view').classList.remove('hidden');
                document.querySelectorAll('.nav-item')[0].classList.add('active');
            } else if (view === 'products') {
                document.getElementById('products-view').classList.remove('hidden');
                document.querySelectorAll('.nav-item')[1].classList.add('active');
                loadProducts();
            } else if (view === 'list') {
                document.getElementById('list-view').classList.remove('hidden');
                document.querySelectorAll('.nav-item')[2].classList.add('active');
                refreshShoppingList();
            }
        }

        // Toast notification
        function showToast(message, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            initDB();
        });
    </script>
</body>
</html>
